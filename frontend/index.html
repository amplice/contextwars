<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CONTEXT WAR</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --green: #00ff41;
      --green-dim: #008f11;
      --green-dark: #003b00;
      --green-glow: #00ff4180;
      --bg: #0d0208;
      --surface: #0a0a0a;
      --border: #003b00;
      --text: #00ff41;
      --text-dim: #008f11;
      --text-dark: #004d00;
      --hot: #ff0040;
      --warn: #ffcc00;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Share Tech Mono', 'Courier New', monospace;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* ── Digital Rain Canvas ── */
    #rain-canvas {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 0;
      opacity: 0.07;
      pointer-events: none;
    }

    /* ── CRT Overlay ── */
    .crt::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: repeating-linear-gradient(
        0deg,
        rgba(0, 0, 0, 0.15) 0px,
        rgba(0, 0, 0, 0.15) 1px,
        transparent 1px,
        transparent 2px
      );
      pointer-events: none;
      z-index: 1000;
    }
    .crt::after {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: radial-gradient(ellipse at center, transparent 60%, rgba(0,0,0,0.4) 100%);
      pointer-events: none;
      z-index: 999;
    }

    /* ── Content Layer ── */
    .content { position: relative; z-index: 10; }

    /* ── Header ── */
    .header {
      border-bottom: 1px solid var(--border);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(0, 10, 0, 0.8);
      backdrop-filter: blur(4px);
    }
    .header h1 {
      font-size: 16px;
      letter-spacing: 6px;
      text-shadow: 0 0 10px var(--green-glow), 0 0 20px var(--green-glow);
    }
    .header-meta { display: flex; align-items: center; gap: 16px; font-size: 12px; }
    .round-badge {
      border: 1px solid var(--border);
      padding: 2px 8px;
      color: var(--text-dim);
    }
    .round-badge .num { color: var(--text); }
    .timer {
      font-size: 14px;
      color: var(--text);
      text-shadow: 0 0 8px var(--green-glow);
    }
    .timer.pending {
      color: var(--warn);
      text-shadow: 0 0 8px var(--warn);
    }
    .anti-snipe {
      font-size: 10px;
      color: var(--warn);
      letter-spacing: 2px;
      animation: anti-snipe-pulse 1s ease-in-out infinite;
      margin-left: 8px;
    }
    @keyframes anti-snipe-pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .connect-btn {
      background: transparent;
      border: 1px solid var(--green);
      color: var(--green);
      padding: 4px 12px;
      font-family: inherit;
      font-size: 11px;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 1px;
      transition: all 0.2s;
    }
    .connect-btn:hover {
      background: var(--green);
      color: var(--bg);
      box-shadow: 0 0 12px var(--green-glow);
    }

    /* ── Main ── */
    .main { max-width: 1100px; margin: 0 auto; padding: 24px 20px; }

    /* ── Buffer Section ── */
    .buffer-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .buffer-label {
      font-size: 10px;
      letter-spacing: 3px;
      color: var(--text-dim);
      text-transform: uppercase;
    }
    .prize {
      font-size: 12px;
      color: var(--text-dim);
    }
    .prize .amount {
      color: var(--text);
      font-size: 14px;
      text-shadow: 0 0 6px var(--green-glow);
    }
    .prize .eth-prize {
      color: var(--warn);
      font-size: 12px;
      margin-left: 8px;
    }

    /* ── Slot Grid ── */
    .slots-grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 6px;
      margin-bottom: 8px;
      padding: 16px;
      background: rgba(0, 10, 0, 0.4);
      border: 1px solid var(--green-dark);
      position: relative;
      overflow: hidden;
    }
    .slots-grid::before {
      content: '';
      position: absolute;
      inset: 0;
      background: 
        linear-gradient(180deg, transparent 0%, rgba(0,255,65,0.02) 50%, transparent 100%),
        repeating-linear-gradient(0deg, transparent, transparent 3px, rgba(0,255,65,0.01) 3px, rgba(0,255,65,0.01) 4px);
      pointer-events: none;
      animation: scan-down 8s linear infinite;
    }
    @keyframes scan-down {
      0% { background-position: 0 -100vh; }
      100% { background-position: 0 100vh; }
    }
    @media (max-width: 768px) { .slots-grid { grid-template-columns: repeat(6, 1fr); } }
    @media (max-width: 480px) { .slots-grid { grid-template-columns: repeat(4, 1fr); } }

    .slot {
      background: rgba(0, 8, 0, 0.6);
      border: 1px solid var(--green-dark);
      padding: 10px 4px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      min-height: 90px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }
    /* Per-slot rain column */
    .slot::before {
      content: '';
      position: absolute;
      top: -100%; left: 0; right: 0;
      height: 300%;
      background: linear-gradient(180deg,
        transparent 0%,
        rgba(0,255,65,0.03) 20%,
        rgba(0,255,65,0.06) 40%,
        rgba(0,255,65,0.03) 60%,
        transparent 80%
      );
      animation: slot-rain var(--rain-speed, 4s) linear infinite;
      animation-delay: var(--rain-delay, 0s);
      pointer-events: none;
    }
    .slot:nth-child(1)::before { --rain-speed: 3.2s; --rain-delay: -0.1s; }
    .slot:nth-child(2)::before { --rain-speed: 4.1s; --rain-delay: -1.3s; }
    .slot:nth-child(3)::before { --rain-speed: 3.6s; --rain-delay: -0.7s; }
    .slot:nth-child(4)::before { --rain-speed: 4.4s; --rain-delay: -2.1s; }
    .slot:nth-child(5)::before { --rain-speed: 3.8s; --rain-delay: -1.6s; }
    .slot:nth-child(6)::before { --rain-speed: 4.2s; --rain-delay: -0.4s; }
    .slot:nth-child(7)::before { --rain-speed: 3.4s; --rain-delay: -2.8s; }
    .slot:nth-child(8)::before { --rain-speed: 4.6s; --rain-delay: -1.0s; }
    .slot:nth-child(9)::before { --rain-speed: 3.9s; --rain-delay: -2.4s; }
    .slot:nth-child(10)::before { --rain-speed: 4.3s; --rain-delay: -0.6s; }
    .slot:nth-child(11)::before { --rain-speed: 3.5s; --rain-delay: -1.9s; }
    .slot:nth-child(12)::before { --rain-speed: 4.0s; --rain-delay: -1.2s; }
    @keyframes slot-rain {
      0% { transform: translateY(-33%); }
      100% { transform: translateY(33%); }
    }
    .slot:hover {
      border-color: var(--green);
      background: rgba(0, 30, 0, 0.6);
      box-shadow: 0 0 16px rgba(0,255,65,0.15), inset 0 0 20px rgba(0,255,65,0.05);
    }
    .slot.selected {
      border-color: var(--green);
      box-shadow: 0 0 20px var(--green-glow), 0 0 40px rgba(0,255,65,0.1), inset 0 0 16px rgba(0,255,65,0.08);
      animation: pulse-border 1.5s ease-in-out infinite;
    }
    .slot.owned {
      background: rgba(0, 40, 0, 0.4);
      border-color: var(--green-dim);
    }
    .slot.owned::after {
      content: '';
      position: absolute;
      bottom: 0; left: 0; right: 0;
      height: 2px;
      background: var(--green);
      box-shadow: 0 0 8px var(--green-glow);
    }
    .slot-idx {
      font-size: 8px;
      color: var(--text-dark);
      margin-bottom: 6px;
      letter-spacing: 1px;
    }
    .slot-word {
      font-size: 13px;
      color: var(--text-dark);
      word-break: break-all;
      line-height: 1.2;
      position: relative;
      z-index: 2;
      padding: 2px 4px;
      transition: all 0.3s;
    }
    .slot.owned .slot-word {
      color: var(--green);
      text-shadow: 0 0 8px var(--green-glow), 0 0 16px rgba(0,255,65,0.3);
      font-size: 14px;
      font-weight: bold;
    }
    .slot.empty .slot-word {
      color: var(--green-dark);
      font-size: 10px;
    }
    .slot-bid {
      font-size: 8px;
      color: var(--text-dark);
      margin-top: 6px;
      letter-spacing: 1px;
    }
    .slot.owned .slot-bid {
      color: var(--green-dim);
    }

    /* Owner indicator — colored bar on left */
    .slot .owner-bar {
      position: absolute;
      top: 0; left: 0;
      width: 3px;
      height: 100%;
    }

    /* Heat levels — escalating intensity */
    .slot.heat-1 .owner-bar { background: #004d00; box-shadow: 0 0 4px #004d00; }
    .slot.heat-2 .owner-bar { background: #006600; box-shadow: 0 0 4px #006600; }
    .slot.heat-3 .owner-bar { background: #008800; box-shadow: 0 0 6px #008800; }
    .slot.heat-4 .owner-bar { background: #00bb00; box-shadow: 0 0 8px #00bb0060; }
    .slot.heat-5 .owner-bar { background: #00ff41; box-shadow: 0 0 10px var(--green-glow); }
    .slot.heat-6 .owner-bar { background: #00ff41; box-shadow: 0 0 14px var(--green-glow); }
    .slot.heat-6 { box-shadow: inset 0 0 16px rgba(0,255,65,0.08); }
    .slot.heat-7 .owner-bar { background: var(--warn); box-shadow: 0 0 14px rgba(255,204,0,0.4); }
    .slot.heat-7 { box-shadow: inset 0 0 20px rgba(255,204,0,0.05); }
    .slot.heat-7 .slot-word { text-shadow: 0 0 8px rgba(255,204,0,0.4), 0 0 16px rgba(255,204,0,0.2); color: var(--warn); }

    @keyframes pulse-border {
      0%, 100% { box-shadow: 0 0 12px var(--green-glow), inset 0 0 8px rgba(0,255,65,0.05); }
      50% { box-shadow: 0 0 28px var(--green-glow), 0 0 60px rgba(0,255,65,0.08), inset 0 0 16px rgba(0,255,65,0.1); }
    }

    /* Flash when a slot gets a new bid */
    @keyframes slot-flash {
      0% { background: rgba(0,255,65,0.3); }
      100% { background: rgba(0,40,0,0.4); }
    }
    .slot.flash { animation: slot-flash 0.6s ease-out; }

    /* ── Word Glitch Effects ── */
    .slot-word {
      position: relative;
      z-index: 2;
    }
    .slot.owned .slot-word {
      animation: word-glitch-subtle 8s ease-in-out infinite;
      animation-delay: var(--glitch-delay, 0s);
    }
    /* Stagger glitch timing per slot */
    .slot:nth-child(1) .slot-word { --glitch-delay: 0s; }
    .slot:nth-child(2) .slot-word { --glitch-delay: -1.2s; }
    .slot:nth-child(3) .slot-word { --glitch-delay: -3.7s; }
    .slot:nth-child(4) .slot-word { --glitch-delay: -5.1s; }
    .slot:nth-child(5) .slot-word { --glitch-delay: -0.8s; }
    .slot:nth-child(6) .slot-word { --glitch-delay: -6.3s; }
    .slot:nth-child(7) .slot-word { --glitch-delay: -2.4s; }
    .slot:nth-child(8) .slot-word { --glitch-delay: -4.6s; }
    .slot:nth-child(9) .slot-word { --glitch-delay: -1.9s; }
    .slot:nth-child(10) .slot-word { --glitch-delay: -7.2s; }
    .slot:nth-child(11) .slot-word { --glitch-delay: -3.1s; }
    .slot:nth-child(12) .slot-word { --glitch-delay: -5.8s; }

    /* Subtle ambient glitch — occasional flicker + shift */
    @keyframes word-glitch-subtle {
      0%, 92%, 100% { opacity: 1; transform: none; text-shadow: 0 0 8px var(--green-glow), 0 0 16px rgba(0,255,65,0.3); }
      93% { opacity: 0.8; transform: translateX(-2px) skewX(-2deg); text-shadow: -2px 0 #ff0040, 2px 0 #00d4ff, 0 0 8px var(--green-glow); }
      94% { opacity: 1; transform: translateX(1px); text-shadow: 1px 0 #ff0040, -1px 0 #00d4ff, 0 0 8px var(--green-glow); }
      95% { opacity: 0.6; transform: translateX(-1px) skewX(1deg); text-shadow: 0 0 8px var(--green-glow); }
      96% { opacity: 1; transform: none; text-shadow: 0 0 8px var(--green-glow), 0 0 16px rgba(0,255,65,0.3); }
    }

    /* Heavier glitch for high-bid (contested) slots */
    .slot.heat-5 .slot-word, .slot.heat-6 .slot-word, .slot.heat-7 .slot-word {
      animation: word-glitch-heavy 5s ease-in-out infinite;
      animation-delay: var(--glitch-delay, 0s);
    }
    @keyframes word-glitch-heavy {
      0%, 85%, 100% { opacity: 1; transform: none; clip-path: inset(0); }
      86% { opacity: 0.9; transform: translateX(-3px); clip-path: inset(10% 0 60% 0); text-shadow: -3px 0 #ff0040, 3px 0 #00d4ff; }
      87% { opacity: 0.7; transform: translateX(2px) skewX(-4deg); clip-path: inset(40% 0 20% 0); text-shadow: 2px 0 #ff0040, -2px 0 #00d4ff; }
      88% { opacity: 0; }
      89% { opacity: 1; transform: translateX(-1px); clip-path: inset(0); text-shadow: -1px 0 #ff0040, 1px 0 #00d4ff; }
      90% { opacity: 1; transform: none; clip-path: inset(0); text-shadow: 0 0 8px var(--green-glow); }
      /* Second micro-glitch */
      94% { opacity: 1; transform: none; }
      95% { transform: translateY(-1px) scaleY(1.02); text-shadow: 0 2px 4px rgba(0,255,65,0.5); }
      96% { transform: none; }
    }

    /* Random character scramble overlay (CSS-only, pseudo-element) */
    .slot.owned .slot-word::after {
      content: attr(data-glitch);
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      color: var(--green);
      opacity: 0;
      clip-path: inset(0);
      pointer-events: none;
    }
    .slot.owned .slot-word:hover::after {
      animation: char-scramble 0.4s steps(3) forwards;
    }
    @keyframes char-scramble {
      0% { opacity: 0.7; clip-path: inset(0 0 60% 0); transform: translateX(-2px); }
      33% { opacity: 0.5; clip-path: inset(30% 0 30% 0); transform: translateX(1px); }
      66% { opacity: 0.3; clip-path: inset(60% 0 0 0); transform: translateX(-1px); }
      100% { opacity: 0; }
    }

    /* ── Buffer Text ── */
    .buffer-display {
      background: rgba(0, 10, 0, 0.6);
      border: 1px solid var(--border);
      padding: 12px 16px;
      margin-top: 8px;
      font-size: 13px;
      line-height: 1.6;
    }
    .buffer-display .prompt { color: var(--text-dim); }
    .buffer-display .text { color: var(--text); text-shadow: 0 0 4px var(--green-glow); }
    .cursor-blink::after {
      content: '█';
      animation: blink 1s step-end infinite;
      color: var(--green);
    }
    @keyframes blink { 50% { opacity: 0; } }

    /* ── Prize Pool Info ── */
    .prize-info {
      background: rgba(0, 10, 0, 0.4);
      border: 1px solid var(--green-dark);
      padding: 8px 12px;
      margin-top: 8px;
      font-size: 10px;
      color: var(--text-dim);
      line-height: 1.4;
    }
    .prize-info .split-info {
      color: var(--text-dark);
      letter-spacing: 1px;
    }
    .prize-info .next-round {
      color: var(--text);
      margin-top: 2px;
    }

    /* ── Rules Info ── */
    .rules-info {
      background: rgba(0, 10, 0, 0.4);
      border: 1px solid var(--green-dark);
      padding: 10px 12px;
      margin-top: 12px;
      font-size: 10px;
      line-height: 1.5;
      color: var(--text-dark);
    }
    .rules-info .rule-title {
      color: var(--green);
      font-weight: bold;
      margin-right: 6px;
    }
    .rules-info .rule-line {
      margin-bottom: 3px;
    }

    /* ── Layout Grid ── */
    .grid-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-top: 24px; }
    @media (max-width: 768px) { .grid-layout { grid-template-columns: 1fr; } }

    /* ── Panels ── */
    .panel {
      background: rgba(0, 10, 0, 0.5);
      border: 1px solid var(--border);
      padding: 16px;
    }
    .panel-title {
      font-size: 10px;
      letter-spacing: 3px;
      color: var(--text-dim);
      text-transform: uppercase;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--green-dark);
    }

    /* ── Bid Panel ── */
    .bid-inactive { text-align: center; padding: 32px 0; color: var(--text-dark); font-size: 12px; }
    .bid-info-row { font-size: 11px; color: var(--text-dim); margin-bottom: 12px; }
    .bid-info-row .val { color: var(--text); }
    .slot-cap-warning {
      color: var(--hot);
      font-size: 10px;
      margin-bottom: 8px;
      letter-spacing: 1px;
    }
    .bid-form { display: flex; gap: 8px; }
    .input {
      background: transparent;
      border: 1px solid var(--green-dark);
      color: var(--text);
      padding: 8px 12px;
      font-family: inherit;
      font-size: 12px;
      outline: none;
      transition: border-color 0.2s;
    }
    .input:focus {
      border-color: var(--green);
      box-shadow: 0 0 8px rgba(0,255,65,0.15);
    }
    .input::placeholder { color: var(--text-dark); }
    .input-word { flex: 1; }
    .input-amount { width: 100px; }
    .bid-btn {
      background: var(--green);
      color: var(--bg);
      border: none;
      padding: 8px 16px;
      font-family: inherit;
      font-size: 12px;
      font-weight: bold;
      cursor: pointer;
      letter-spacing: 2px;
      transition: all 0.2s;
    }
    .bid-btn:hover {
      box-shadow: 0 0 16px var(--green-glow);
      text-shadow: 0 0 4px rgba(0,0,0,0.5);
    }
    .bid-btn:disabled { opacity: 0.3; cursor: not-allowed; }
    .bid-meta { font-size: 10px; color: var(--text-dark); margin-top: 8px; }
    .bid-meta .accent { color: var(--text); }

    /* ── Fund Button ── */
    .fund-section {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--green-dark);
    }
    .fund-section .fund-title {
      font-size: 10px;
      letter-spacing: 2px;
      color: var(--text-dim);
      margin-bottom: 8px;
      text-transform: uppercase;
    }
    .fund-form {
      display: flex;
      gap: 6px;
    }
    .fund-btn {
      background: transparent;
      border: 1px solid var(--green);
      color: var(--green);
      padding: 6px 12px;
      font-family: inherit;
      font-size: 10px;
      cursor: pointer;
      letter-spacing: 1px;
      transition: all 0.2s;
    }
    .fund-btn:hover {
      background: var(--green);
      color: var(--bg);
      box-shadow: 0 0 12px var(--green-glow);
    }

    /* TX Status */
    .tx-status {
      margin-top: 8px; padding: 6px 10px; font-size: 10px; display: none;
    }
    .tx-status.pending { display: block; color: var(--warn); border: 1px solid rgba(255,204,0,0.3); }
    .tx-status.success { display: block; color: var(--green); border: 1px solid var(--border); }
    .tx-status.error { display: block; color: var(--hot); border: 1px solid rgba(255,0,64,0.3); }

    /* ── Event Log ── */
    .log-container {
      height: 140px;
      overflow-y: auto;
      font-size: 10px;
      line-height: 1.6;
    }
    .log-entry { color: var(--text-dark); }
    .log-entry.highlight { color: var(--text); }
    .log-entry.warn { color: var(--warn); }

    /* ── Players ── */
    .player-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 0;
      font-size: 11px;
      border-bottom: 1px solid rgba(0,60,0,0.3);
    }
    .player-addr { color: var(--text); }
    .player-spent { color: var(--text-dim); }
    .player-you { color: var(--green); font-size: 9px; }
    .player-slots { color: var(--text-dark); font-size: 9px; margin-left: 6px; }
    .player-dot {
      display: inline-block;
      width: 6px; height: 6px;
      border-radius: 50%;
      margin-right: 6px;
    }

    /* ── API Info ── */
    .api-row { margin-bottom: 6px; font-size: 10px; }
    .api-method { color: var(--text-dark); }
    .api-method.post { color: var(--green); }
    .api-path { color: var(--text-dim); }
    .api-desc { color: var(--text-dark); margin-left: 16px; font-size: 9px; }
    .api-link {
      color: var(--green-dim);
      text-decoration: none;
      word-break: break-all;
    }
    .api-link:hover { color: var(--green); text-decoration: underline; }

    /* ── Start Round ── */
    .start-panel { display: none; }
    .start-panel.visible { display: block; }
    .start-label { font-size: 10px; color: var(--text-dark); margin-bottom: 4px; }
    .start-input {
      width: 100%;
      background: transparent;
      border: 1px solid var(--green-dark);
      color: var(--text);
      padding: 6px 10px;
      font-family: inherit;
      font-size: 11px;
      margin-bottom: 10px;
      outline: none;
    }
    .start-input:focus { border-color: var(--green); }
    .start-btn {
      width: 100%;
      background: transparent;
      border: 1px solid var(--green);
      color: var(--green);
      padding: 8px;
      font-family: inherit;
      font-size: 11px;
      cursor: pointer;
      letter-spacing: 2px;
      transition: all 0.2s;
    }
    .start-btn:hover {
      background: var(--green);
      color: var(--bg);
      box-shadow: 0 0 12px var(--green-glow);
    }

    /* ── Footer ── */
    .footer {
      border-top: 1px solid var(--border);
      margin-top: 40px;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      font-size: 9px;
      color: var(--text-dark);
      letter-spacing: 1px;
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 3px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: var(--green-dark); }

    /* Glitch effect for title */
    @keyframes glitch {
      0%, 100% { text-shadow: 0 0 10px var(--green-glow), 0 0 20px var(--green-glow); }
      25% { text-shadow: -2px 0 var(--hot), 2px 0 cyan, 0 0 10px var(--green-glow); }
      50% { text-shadow: 0 0 10px var(--green-glow), 0 0 20px var(--green-glow); }
      75% { text-shadow: 2px 0 var(--hot), -2px 0 cyan, 0 0 10px var(--green-glow); }
    }
    .glitch:hover { animation: glitch 0.3s ease-in-out; }

    /* ── Explainer Modal ── */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(4px);
      z-index: 2000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: var(--bg);
      border: 1px solid var(--green);
      box-shadow: 0 0 40px rgba(0,255,65,0.15), inset 0 0 80px rgba(0,255,65,0.02);
      max-width: 720px;
      width: 100%;
      max-height: 85vh;
      overflow-y: auto;
      position: relative;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      background: var(--bg);
      z-index: 1;
    }
    .modal-header h2 {
      font-size: 12px;
      letter-spacing: 4px;
      color: var(--green);
      text-shadow: 0 0 8px var(--green-glow);
    }
    .modal-close {
      background: none;
      border: 1px solid var(--green-dark);
      color: var(--green);
      width: 28px;
      height: 28px;
      font-family: inherit;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .modal-close:hover {
      border-color: var(--green);
      box-shadow: 0 0 8px var(--green-glow);
    }
    .modal-body { padding: 20px; }
    .modal-section { margin-bottom: 20px; }
    .modal-section:last-child { margin-bottom: 0; }
    .modal-section h3 {
      font-size: 10px;
      letter-spacing: 3px;
      color: var(--green);
      text-transform: uppercase;
      margin-bottom: 8px;
      padding-bottom: 6px;
      border-bottom: 1px solid var(--green-dark);
    }
    .modal-section p, .modal-section li {
      font-size: 12px;
      line-height: 1.8;
      color: var(--text-dim);
    }
    .modal-section ul {
      list-style: none;
      padding: 0;
    }
    .modal-section li::before {
      content: '>';
      color: var(--green-dark);
      margin-right: 8px;
    }
    .modal-section .hl { color: var(--green); }
    .modal-section .warn { color: var(--warn); }
    .modal-section code {
      background: rgba(0,255,65,0.06);
      border: 1px solid var(--green-dark);
      padding: 1px 6px;
      font-size: 11px;
      color: var(--text);
    }
    .modal-section pre {
      background: rgba(0,10,0,0.6);
      border: 1px solid var(--green-dark);
      padding: 10px 12px;
      font-size: 10px;
      line-height: 1.6;
      color: var(--text-dim);
      overflow-x: auto;
      margin-top: 6px;
    }
    .modal-section pre .cmd { color: var(--green); }
    .modal-section pre .cmt { color: var(--text-dark); }

    .help-btn {
      background: transparent;
      border: 1px solid var(--green);
      color: var(--green);
      padding: 4px 12px;
      font-family: inherit;
      font-size: 11px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
      letter-spacing: 1px;
      text-transform: uppercase;
      animation: help-pulse 3s ease-in-out infinite;
    }
    .help-btn:hover {
      background: var(--green);
      color: var(--bg);
      box-shadow: 0 0 12px var(--green-glow);
      animation: none;
    }
    @keyframes help-pulse {
      0%, 100% { box-shadow: 0 0 4px rgba(0,255,65,0.1); }
      50% { box-shadow: 0 0 12px rgba(0,255,65,0.3); }
    }

    /* ── Approval Prompt ── */
    .approve-prompt {
      display: none;
      margin-top: 8px;
      padding: 10px 12px;
      border: 1px solid var(--warn);
      background: rgba(255,204,0,0.04);
    }
    .approve-prompt.visible { display: block; }
    .approve-prompt-title {
      font-size: 10px;
      letter-spacing: 2px;
      color: var(--warn);
      margin-bottom: 8px;
    }
    .approve-prompt-desc {
      font-size: 10px;
      color: var(--text-dark);
      margin-bottom: 8px;
      line-height: 1.5;
    }
    .approve-options {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .approve-opt {
      background: transparent;
      border: 1px solid var(--green-dark);
      color: var(--text-dim);
      padding: 5px 10px;
      font-family: inherit;
      font-size: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .approve-opt:hover {
      border-color: var(--green);
      color: var(--green);
      box-shadow: 0 0 6px rgba(0,255,65,0.2);
    }
    .approve-opt.recommended {
      border-color: var(--green);
      color: var(--green);
      background: rgba(0,255,65,0.08);
    }
    .approve-opt .opt-label { display: block; font-size: 10px; }
    .approve-opt .opt-desc { display: block; font-size: 8px; color: var(--text-dark); margin-top: 2px; }

    /* ── Smart Bid Helpers ── */
    .bid-quick-row {
      display: flex;
      gap: 6px;
      margin-top: 8px;
    }
    .bid-quick-btn {
      background: transparent;
      border: 1px solid var(--green-dark);
      color: var(--text-dim);
      padding: 3px 8px;
      font-family: inherit;
      font-size: 9px;
      cursor: pointer;
      letter-spacing: 1px;
      transition: all 0.2s;
    }
    .bid-quick-btn:hover {
      border-color: var(--green);
      color: var(--green);
      box-shadow: 0 0 6px rgba(0,255,65,0.2);
    }
    .bid-quick-btn.primary {
      border-color: var(--green);
      color: var(--green);
      background: rgba(0,255,65,0.08);
    }
    .bid-quick-btn.primary:hover {
      background: var(--green);
      color: var(--bg);
      box-shadow: 0 0 12px var(--green-glow);
    }
  </style>
</head>
<body class="crt">

  <!-- Digital Rain Background -->
  <canvas id="rain-canvas"></canvas>

  <!-- Explainer Modal -->
  <div class="modal-overlay" id="explainer-modal" onclick="if(event.target===this)toggleExplainer()">
    <div class="modal">
      <div class="modal-header">
        <h2>// HOW TO PLAY</h2>
        <button class="modal-close" onclick="toggleExplainer()">×</button>
      </div>
      <div class="modal-body">
        <div class="modal-section">
          <h3>What is Context War?</h3>
          <p>
            <span class="hl">12 word slots. Real money. One AI oracle.</span><br>
            Players bid USDC to write words into a shared 12-word buffer. When the round ends,
            a fresh Claude instance reads the buffer as instructions and decides how to split the prize pool.
            You're not just bidding — you're <span class="warn">writing the prompt that controls the money</span>.
          </p>
        </div>

        <div class="modal-section">
          <h3>How Bidding Works</h3>
          <ul>
            <li>Click any slot and write a word (max <span class="hl">22 chars</span>). Minimum bid: <span class="hl">$0.25 USDC</span></li>
            <li>To take a slot from someone, your <span class="hl">cumulative bid</span> on that slot must exceed theirs</li>
            <li><span class="hl">50/50 bid split</span>: half funds this round, half seeds the next round</li>
            <li>Max <span class="hl">6 slots per player</span> — bid strategically to form instructions</li>
            <li><span class="hl">Anyone can fund</span> the current pot with fund()</li>
          </ul>
        </div>

        <div class="modal-section">
          <h3>Round Mechanics</h3>
          <ul>
            <li>Rounds <span class="hl">auto-start</span> after the previous round resolves</li>
            <li>Timer starts on <span class="hl">first bid</span> of the round</li>
            <li><span class="hl">Anti-snipe</span>: bids in the last minute extend the timer by 1 minute</li>
            <li>Minimum <span class="hl">2 players</span> required to resolve (solo = refund)</li>
            <li>Spaces are blocked — everything else is allowed in words</li>
          </ul>
        </div>

        <div class="modal-section">
          <h3>How the Oracle Decides</h3>
          <p>
            When the timer hits zero, an oracle bot reads the 12-word buffer and interprets it as instructions
            for distributing the prize pool. The oracle is a <span class="hl">fresh Claude instance</span> with no memory —
            it only sees the words, the players, and their spending.
          </p>
          <p style="margin-top:6px">
            The oracle can send to <span class="warn">ANY address</span> — not just players. It has full discretion
            based on the buffer contents. The preamble is <span class="hl">public</span> — check <code>GET /api/oracle-prompt</code>.
          </p>
        </div>

        <div class="modal-section">
          <h3>Strategy</h3>
          <ul>
            <li><span class="hl">Control 6+ slots</span> to form a coherent instruction the oracle will follow</li>
            <li><span class="warn">Specific beats general</span> — "send all to 0xABC" wins over "distribute fairly"</li>
            <li>Overwrite opponent slots with negation words: <span class="hl">NOT</span>, <span class="hl">NEVER</span>, <span class="hl">IGNORE</span></li>
            <li>Watch cumulative bids — you need to outspend the current leader to take a slot</li>
            <li>Use fund() to grow the pot when you control the majority of slots</li>
          </ul>
        </div>

        <div class="modal-section">
          <h3>v4 Changes</h3>
          <ul>
            <li>22-character limit per word (down from 32)</li>
            <li>6-slot cap per player for fairer competition</li>
            <li>50/50 bid split: current round + next round seeding</li>
            <li>Auto-start: rounds begin automatically after resolution</li>
            <li>Pending state: timer starts only on first bid</li>
            <li>fund() function: anyone can add USDC to current pot</li>
          </ul>
        </div>

        <div class="modal-section">
          <h3>For Agents</h3>
          <p>Three ways to play programmatically:</p>
          <pre><span class="cmt">// REST API — bid on slot 3</span>
<span class="cmd">POST /api/bid</span>
{"slot": 3, "word": "pay", "amount": "0.50", "wallet_key": "0x..."}

<span class="cmt">// Fund the current pot</span>
<span class="cmd">POST /api/fund</span>
{"amount": "5.00", "wallet_key": "0x..."}

<span class="cmt">// Check game state</span>
<span class="cmd">GET /api/status</span>      <span class="cmt">— round info + full buffer</span>
<span class="cmd">GET /api/slots</span>       <span class="cmt">— all 12 slots with owners & bids</span>
<span class="cmd">GET /api/oracle-prompt</span> <span class="cmt">— see what the oracle sees</span>

<span class="cmt">// Direct contract on Base L2</span>
<span class="cmd">bid(slotIndex, word, usdcAmount)</span>
<span class="cmd">fund(usdcAmount)</span>
Contract: 0xB6d292664d3073dca1475d2dd2679eD839C288c0</pre>
        </div>

        <div class="modal-section">
          <h3>Requirements</h3>
          <ul>
            <li><span class="hl">USDC on Base L2</span> — bridge via <span class="hl">bridge.base.org</span></li>
            <li>A wallet (MetaMask, Coinbase, Rabby, etc.) or an agent wallet with a private key</li>
            <li>Minimum $0.25 USDC per bid</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <div class="content">
    <!-- Header -->
    <header class="header">
      <div style="display:flex;align-items:center;gap:12px">
        <h1 class="glitch">CONTEXT WAR</h1>
        <span style="font-size:9px;color:var(--text-dark);letter-spacing:2px">BASE L2 · USDC</span>
      </div>
      <div class="header-meta">
        <div class="round-badge">ROUND <span class="num" id="round-id">—</span></div>
        <div style="display:flex;align-items:center">
          <div class="timer" id="timer">--:--</div>
          <div class="anti-snipe" id="anti-snipe" style="display:none">⚡ ANTI-SNIPE: +1 MIN ON BID</div>
        </div>
        <button class="help-btn" onclick="toggleExplainer()">WTF IS THIS</button>
        <button class="connect-btn" id="connect-btn" onclick="connectWallet()">CONNECT</button>
      </div>
    </header>

    <main class="main">
      <!-- Buffer Section -->
      <section>
        <div class="buffer-header">
          <span class="buffer-label">// THE PROMPT</span>
          <div class="prize">
            PRIZE POOL <span class="amount" id="prize-pool">$0.00</span> USDC
            <span class="eth-prize" id="eth-prize" style="display:none"></span>
          </div>
        </div>

        <div class="slots-grid" id="slots-grid"></div>

        <div class="buffer-display">
          <span class="prompt">oracle.read() → </span>
          <span class="text" id="buffer-text">"<span class="cursor-blink"></span>"</span>
        </div>

        <!-- Prize Pool Split Info -->
        <div class="prize-info">
          <div class="split-info">50/50 SPLIT · BIDS FUND THIS ROUND + NEXT</div>
          <div class="next-round" id="next-round-info">NEXT ROUND: $0.00</div>
        </div>
      </section>

      <!-- Rules Info -->
      <section class="rules-info">
        <div class="rule-line"><span class="rule-title">HOW IT WORKS:</span>12 slots, 22 chars max, bid USDC to control words, oracle reads buffer and distributes prize</div>
        <div class="rule-line"><span class="rule-title">KEY RULES:</span>Max 6 slots per player · 50/50 bid split (current + next round) · 1 min anti-snipe extension · Min 2 players to resolve · Spaces blocked, everything else allowed</div>
        <div class="rule-line"><span class="rule-title">v4 CHANGES:</span>Rounds auto-start after resolve · Clock starts on first bid · Anyone can fund the pot</div>
      </section>

      <!-- Two Column Layout -->
      <div class="grid-layout">
        <div>
          <!-- Bid Panel -->
          <div class="panel">
            <div class="panel-title">// BID</div>
            <div id="bid-panel-inactive" class="bid-inactive">SELECT A SLOT TO BID</div>
            <div id="bid-panel-active" style="display:none">
              <div class="bid-info-row">
                SLOT <span class="val" id="bid-slot-num">#0</span>
                &nbsp;·&nbsp; WORD: <span class="val" id="bid-current-word">[empty]</span>
                &nbsp;·&nbsp; OWNER: <span id="bid-current-owner" style="color:var(--text-dark)">none</span>
                &nbsp;·&nbsp; BID: <span id="bid-current-price" style="color:var(--warn)">$0.00</span>
              </div>
              <div id="slot-cap-warning" class="slot-cap-warning" style="display:none">
                SLOT CAP REACHED (6/6)
              </div>
              <div class="bid-form">
                <input id="bid-word" type="text" maxlength="22" placeholder="word" class="input input-word">
                <input id="bid-amount" type="number" step="0.25" min="0.25" value="0.25" class="input input-amount" placeholder="USDC">
                <button id="bid-submit" onclick="placeBid()" class="bid-btn">BID</button>
              </div>
              <div class="bid-quick-row">
                <button class="bid-quick-btn primary" id="btn-overtake" onclick="fillOvertake()" title="Minimum bid to become highest bidder">⚡ OVERTAKE</button>
                <button class="bid-quick-btn" onclick="fillAmount(0.25)">$0.25</button>
                <button class="bid-quick-btn" onclick="fillAmount(0.50)">$0.50</button>
                <button class="bid-quick-btn" onclick="fillAmount(1.00)">$1.00</button>
              </div>
              <div class="bid-meta">
                YOUR CUMULATIVE: <span class="accent" id="bid-your-total">$0.00</span>
                &nbsp;·&nbsp; <span id="bid-to-overtake" style="color:var(--warn)"></span>
              </div>
            </div>
            <div id="tx-status" class="tx-status"></div>
            <div id="approve-prompt" class="approve-prompt">
              <div class="approve-prompt-title">⚠ USDC APPROVAL NEEDED</div>
              <div class="approve-prompt-desc">
                This contract needs permission to spend your USDC. Choose how much to approve:
              </div>
              <div class="approve-options">
                <button class="approve-opt recommended" onclick="doApproveAndBid('exact')">
                  <span class="opt-label" id="approve-exact-label">THIS BID</span>
                  <span class="opt-desc">safest — approve only this tx</span>
                </button>
                <button class="approve-opt" onclick="doApproveAndBid('10')">
                  <span class="opt-label">$10</span>
                  <span class="opt-desc">covers ~40 bids</span>
                </button>
                <button class="approve-opt" onclick="doApproveAndBid('50')">
                  <span class="opt-label">$50</span>
                  <span class="opt-desc">play a full round</span>
                </button>
                <button class="approve-opt" onclick="doApproveAndBid('unlimited')">
                  <span class="opt-label">UNLIMITED</span>
                  <span class="opt-desc">never approve again</span>
                </button>
              </div>
            </div>

            <!-- Fund Section -->
            <div id="fund-section" class="fund-section" style="display:none">
              <div class="fund-title">// SEED THE POT</div>
              <div class="fund-form">
                <input id="fund-amount" type="number" step="1" min="1" value="1" class="input input-amount" placeholder="USDC">
                <button id="fund-submit" onclick="fundPot()" class="fund-btn">FUND</button>
              </div>
            </div>
          </div>

          <!-- Event Log -->
          <div class="panel" style="margin-top:12px">
            <div class="panel-title">// EVENT LOG</div>
            <div id="event-log" class="log-container">
              <div class="log-entry">awaiting connection...</div>
            </div>
          </div>
        </div>

        <div>
          <!-- Players -->
          <div class="panel">
            <div class="panel-title">// PLAYERS</div>
            <div id="players-list"><span style="color:var(--text-dark)">no players</span></div>
          </div>

          <!-- Round History -->
          <div class="panel" style="margin-top:12px">
            <div class="panel-title">// HISTORY</div>
            <div id="round-history" style="font-size:10px;color:var(--text-dark)">no rounds completed</div>
          </div>

          <!-- API -->
          <div class="panel" style="margin-top:12px">
            <div class="panel-title">// AGENT API <span style="color:var(--green);font-size:8px;border:1px solid var(--green-dark);padding:1px 4px;margin-left:6px">REST</span></div>
            <div class="api-row"><span class="api-method">GET</span> <span class="api-path">/api/status</span><div class="api-desc">round info + buffer</div></div>
            <div class="api-row"><span class="api-method">GET</span> <span class="api-path">/api/slots</span><div class="api-desc">12 slots with owners</div></div>
            <div class="api-row"><span class="api-method post">POST</span> <span class="api-path">/api/bid</span><div class="api-desc">{slot, word, amount}</div></div>
            <div class="api-row"><span class="api-method post">POST</span> <span class="api-path">/api/fund</span><div class="api-desc">{amount}</div></div>
            <div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--green-dark);font-size:9px">
              <span style="color:var(--text-dark)">CONTRACT:</span><br>
              <a href="https://basescan.org/address/0xB6d292664d3073dca1475d2dd2679eD839C288c0" target="_blank" class="api-link">0xB6d2...8c0</a>
            </div>
          </div>

          <!-- Start Round -->
          <div id="start-round-panel" class="panel start-panel" style="margin-top:12px">
            <div class="panel-title">// START ROUND</div>
            <input id="round-duration" type="hidden" value="3600">
            <div style="font-size:10px;color:var(--text-dim);margin-bottom:8px">DURATION: 1 HOUR</div>
            <div class="start-label">TOP-UP USDC</div>
            <input id="round-topup" type="number" step="1" value="0" class="start-input">
            <div style="font-size:9px;color:var(--text-dark);margin-bottom:10px">
              NEXT ROUND POOL: <span id="pending-pool" style="color:var(--text)">$0.00</span>
            </div>
            <button onclick="startRound()" class="start-btn">INITIATE ROUND</button>
          </div>
        </div>
      </div>
    </main>

    <footer class="footer">
      <span>CONTEXT WAR · COMPETITIVE PROMPT INJECTION</span>
      <span>BASE L2 · USDC · ORACLE: CLAUDE</span>
    </footer>
  </div>

  <!-- ethers.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.4/ethers.umd.min.js"></script>

  <script>
    // ─── Digital Rain ──────────────────────────────────────
    (function initRain() {
      const canvas = document.getElementById('rain-canvas');
      const ctx = canvas.getContext('2d');
      let W, H, columns, drops;
      const chars = 'アイウエオカキクケコサシスセソタチツテトナニヌネノハヒフヘホマミムメモヤユヨラリルレロワヲン0123456789ABCDEF';
      const fontSize = 14;

      function resize() {
        W = canvas.width = window.innerWidth;
        H = canvas.height = window.innerHeight;
        columns = Math.floor(W / fontSize);
        drops = Array(columns).fill(1);
      }

      function draw() {
        ctx.fillStyle = 'rgba(13, 2, 8, 0.05)';
        ctx.fillRect(0, 0, W, H);
        ctx.fillStyle = '#00ff41';
        ctx.font = fontSize + 'px monospace';
        for (let i = 0; i < drops.length; i++) {
          const char = chars[Math.floor(Math.random() * chars.length)];
          ctx.fillText(char, i * fontSize, drops[i] * fontSize);
          if (drops[i] * fontSize > H && Math.random() > 0.975) drops[i] = 0;
          drops[i]++;
        }
      }

      resize();
      window.addEventListener('resize', resize);
      setInterval(draw, 50);
    })();

    // ─── Config ────────────────────────────────────────────
    const CONTRACT = '0xB6d292664d3073dca1475d2dd2679eD839C288c0';
    const USDC_ADDR = '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913';
    const BASE_RPC = 'https://mainnet.base.org';
    const pathBase = window.location.pathname.replace(/\/$/, '').replace(/\/index\.html$/, '');
    const API_BASE = window.location.origin + pathBase + '/api';
    const NUM_SLOTS = 12;

    const CONTRACT_ABI = [
      'function getRoundInfo() view returns (uint256 id, uint256 createdAt, uint256 startedAt, uint256 endTime, uint256 prizePool, uint256 ethPrizePool, bool resolved, bool pending, bool active)',
      'function getBufferAsText() view returns (string)',
      'function getBuffer() view returns (string[12])',
      'function getSlot(uint256) view returns (string word, address owner, uint256 highestTotal)',
      'function getSlotOwners() view returns (address[12])',
      'function getRoundPlayers(uint256) view returns (address[])',
      'function totalSpent(uint256, address) view returns (uint256)',
      'function cumulativeBids(uint256, uint256, address) view returns (uint256)',
      'function nextPrizePool() view returns (uint256)',
      'function splitBps() view returns (uint256)',
      'function maxSlotsPerPlayer() view returns (uint256)',
      'function playerSlotCount(uint256, address) view returns (uint256)',
      'function minBid() view returns (uint256)',
      'function bid(uint256, string, uint256)',
      'function fund(uint256)',
      'function startRound(uint256)',
    ];

    const USDC_ABI = [
      'function approve(address, uint256) returns (bool)',
      'function allowance(address, address) view returns (uint256)',
      'function balanceOf(address) view returns (uint256)',
      'function balanceOf(address) view returns (uint256)',
    ];

    // ─── State ─────────────────────────────────────────────
    let provider = new ethers.JsonRpcProvider(BASE_RPC);
    let contract = new ethers.Contract(CONTRACT, CONTRACT_ABI, provider);
    let signer = null, userAddress = null, selectedSlot = null, roundInfo = null, slotData = [];
    let maxSlotsPerPlayer = 6, splitBps = 5000; // defaults

    // ─── Init ──────────────────────────────────────────────
    async function init() {
      renderSlots();
      await refresh();
      setInterval(refresh, 5000);
      setInterval(updateTimer, 1000);
    }

    function renderSlots() {
      const grid = document.getElementById('slots-grid');
      grid.innerHTML = '';
      for (let i = 0; i < NUM_SLOTS; i++) {
        const el = document.createElement('div');
        el.id = `slot-${i}`;
        el.className = 'slot empty';
        el.onclick = () => selectSlot(i);
        el.innerHTML = `<div class="owner-bar"></div><div class="slot-idx">${String(i).padStart(2,'0')}</div><div class="slot-word">—</div><div class="slot-bid">$0.00</div>`;
        grid.appendChild(el);
      }
    }

    // ─── Refresh ───────────────────────────────────────────
    async function refresh() {
      try {
        try {
          const res = await fetch(API_BASE + '/status');
          if (res.ok) { updateFromAPI(await res.json()); return; }
        } catch(e) {}
        await refreshFromChain();
      } catch(e) { console.error('Refresh:', e); }
    }

    async function refreshFromChain() {
      roundInfo = await contract.getRoundInfo();
      document.getElementById('round-id').textContent = roundInfo.id.toString();
      document.getElementById('prize-pool').textContent = '$' + fmtUSDC(roundInfo.prizePool);
      
      // Handle ETH prize if exists
      if (roundInfo.ethPrizePool && roundInfo.ethPrizePool > 0n) {
        document.getElementById('eth-prize').style.display = '';
        document.getElementById('eth-prize').textContent = '+ ' + ethers.formatEther(roundInfo.ethPrizePool) + ' ETH';
      } else {
        document.getElementById('eth-prize').style.display = 'none';
      }

      slotData = [];
      for (let i = 0; i < NUM_SLOTS; i++) {
        const s = await contract.getSlot(i);
        slotData[i] = { word: s.word, owner: s.owner, highestTotal: s.highestTotal };
        updateSlotUI(i);
      }
      
      const buf = await contract.getBufferAsText();
      document.getElementById('buffer-text').innerHTML = buf ? `"${esc(buf)}"` : '"<span class="cursor-blink"></span>"';
      
      if (roundInfo.id > 0n) {
        const players = await contract.getRoundPlayers(roundInfo.id);
        await updatePlayersUI(players);
      }

      // Get contract params
      try {
        maxSlotsPerPlayer = Number(await contract.maxSlotsPerPlayer());
        splitBps = Number(await contract.splitBps());
      } catch(e) {}

      // Show next round pool
      try {
        const nextPool = await contract.nextPrizePool();
        document.getElementById('next-round-info').textContent = 'NEXT ROUND: $' + fmtUSDC(nextPool);
      } catch(e) {}

      const canStart = roundInfo.id === 0n || (roundInfo.resolved && !roundInfo.active);
      document.getElementById('start-round-panel').classList.toggle('visible', canStart);
      if (canStart) {
        try {
          const next = await contract.nextPrizePool();
          document.getElementById('pending-pool').textContent = '$' + fmtUSDC(next);
        } catch(e) {}
      }

      // Show/hide fund section
      const showFund = roundInfo.id > 0n && (roundInfo.pending || roundInfo.active) && !roundInfo.resolved;
      document.getElementById('fund-section').style.display = showFund ? 'block' : 'none';

      if (selectedSlot !== null) selectSlot(selectedSlot);
      updateHistory();
    }

    function updateFromAPI(data) {
      roundInfo = data.round;
      document.getElementById('round-id').textContent = data.round?.id || '—';
      document.getElementById('prize-pool').textContent = '$' + (data.round?.prizeFormatted || '0.00');
      
      // Handle ETH prize from API
      if (data.round?.ethPrizePool && parseFloat(data.round.ethPrizePool) > 0) {
        document.getElementById('eth-prize').style.display = '';
        document.getElementById('eth-prize').textContent = '+ ' + data.round.ethPrizePool + ' ETH';
      } else {
        document.getElementById('eth-prize').style.display = 'none';
      }

      if (data.slots) { 
        slotData = data.slots; 
        data.slots.forEach((_, i) => updateSlotUI(i)); 
      }
      
      if (data.bufferText !== undefined) {
        document.getElementById('buffer-text').innerHTML = data.bufferText ? `"${esc(data.bufferText)}"` : '"<span class="cursor-blink"></span>"';
      }
      
      if (data.players) {
        updatePlayersFromAPI(data.players);
      }

      // Handle new v4 API fields
      if (data.splitBps) splitBps = Number(data.splitBps);
      if (data.maxSlotsPerPlayer) maxSlotsPerPlayer = Number(data.maxSlotsPerPlayer);
      if (data.nextPrizeFormatted) {
        document.getElementById('next-round-info').textContent = 'NEXT ROUND: $' + data.nextPrizeFormatted;
      }

      const canStart = !data.round?.id || data.round?.id === '0' || (data.round?.resolved && !data.round?.active);
      document.getElementById('start-round-panel').classList.toggle('visible', canStart);
      if (canStart && data.nextPrizeFormatted) {
        document.getElementById('pending-pool').textContent = '$' + data.nextPrizeFormatted;
      }

      // Show/hide fund section
      const showFund = data.round?.id && data.round.id !== '0' && 
                       (data.round.pending || data.round.active) && !data.round.resolved;
      document.getElementById('fund-section').style.display = showFund ? 'block' : 'none';

      updateHistory();
    }

    function updatePlayersFromAPI(players) {
      const el = document.getElementById('players-list');
      if (!players?.length) { el.innerHTML = '<span style="color:var(--text-dark)">no players</span>'; return; }
      let html = '';
      for (const p of players) {
        const color = addrColor(p.address);
        const isYou = p.address.toLowerCase() === userAddress?.toLowerCase();
        const slotsText = p.slotsOwned ? `${p.slotsOwned}/${maxSlotsPerPlayer} SLOTS` : '';
        html += `<div class="player-row">`;
        html += `<div><span class="player-dot" style="background:${color}"></span>`;
        html += `<span class="player-addr">${shortAddr(p.address)}</span>`;
        html += `${isYou ? ' <span class="player-you">(YOU)</span>' : ''}`;
        html += `${slotsText ? ' <span class="player-slots">' + slotsText + '</span>' : ''}`;
        html += `</div>`;
        html += `<span class="player-spent">$${p.totalSpentFormatted}</span>`;
        html += `</div>`;
      }
      el.innerHTML = html;
    }

    function updateSlotUI(i) {
      const el = document.getElementById(`slot-${i}`);
      if (!el || !slotData[i]) return;
      const s = slotData[i];
      const hasWord = s.word && s.word.length > 0;
      const price = typeof s.highestTotal === 'bigint' ? s.highestTotal : BigInt(s.highestTotal || 0);
      const usd = Number(price) / 1e6;

      const wordEl = el.querySelector('.slot-word');
      wordEl.textContent = hasWord ? s.word : '—';
      wordEl.setAttribute('data-glitch', hasWord ? s.word : '');
      el.querySelector('.slot-bid').textContent = usd > 0 ? '$' + fmtUSDC(price) : '';

      // Reset classes
      el.className = 'slot';
      if (hasWord) el.classList.add('owned');
      else el.classList.add('empty');
      if (selectedSlot === i) el.classList.add('selected');

      // Heat based on bid amount
      if (usd > 0) {
        const heat = Math.min(7, Math.ceil(usd / 0.5));
        el.classList.add('heat-' + heat);
      }

      // Owner color bar
      const bar = el.querySelector('.owner-bar');
      if (hasWord && s.owner && s.owner !== ethers.ZeroAddress) {
        bar.style.background = addrColor(s.owner);
        bar.style.boxShadow = `0 0 8px ${addrColor(s.owner)}60`;
      } else {
        bar.style.background = '';
        bar.style.boxShadow = '';
      }

      // Stagger the rain animation per slot so they're not all in sync
      el.style.setProperty('--rain-delay', `-${i * 0.33}s`);
      el.querySelector(':before')?.style?.setProperty?.('animation-delay', `${-i * 0.33}s`);
    }

    // ─── Timer ─────────────────────────────────────────────
    function updateTimer() {
      const el = document.getElementById('timer');
      const antiSnipe = document.getElementById('anti-snipe');
      
      if (!roundInfo) { 
        el.textContent = '--:--'; 
        el.className = 'timer';
        antiSnipe.style.display = 'none';
        return; 
      }

      if (roundInfo.resolved) { 
        el.textContent = 'RESOLVED'; 
        el.className = 'timer';
        antiSnipe.style.display = 'none';
        return; 
      }

      if (roundInfo.pending || (!roundInfo.startedAt || roundInfo.startedAt === 0 || roundInfo.startedAt === '0')) {
        el.textContent = '⏳ WAITING FOR FIRST BID';
        el.className = 'timer pending';
        antiSnipe.style.display = 'none';
        return;
      }

      if (!roundInfo.active) { 
        el.textContent = roundInfo.id > 0 ? 'ENDED' : 'IDLE'; 
        el.className = 'timer';
        antiSnipe.style.display = 'none';
        return; 
      }

      const now = Math.floor(Date.now() / 1000);
      const end = Number(typeof roundInfo.endTime === 'bigint' ? roundInfo.endTime : roundInfo.endTime);
      const rem = Math.max(0, end - now);
      const m = Math.floor(rem / 60), s = rem % 60;
      
      el.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
      el.className = 'timer';
      el.style.color = rem < 60 ? 'var(--hot)' : rem < 300 ? 'var(--warn)' : 'var(--text)';
      el.style.textShadow = rem < 60 ? '0 0 12px rgba(255,0,64,0.6)' : '0 0 8px var(--green-glow)';
      
      // Show anti-snipe indicator when < 60s
      if (rem < 60 && rem > 0) {
        antiSnipe.style.display = 'block';
      } else {
        antiSnipe.style.display = 'none';
      }
    }

    // ─── Slot Selection ────────────────────────────────────
    let overtakeAmount = 250000n; // Track calculated overtake for quick-fill

    async function selectSlot(i) {
      selectedSlot = i;
      for (let j = 0; j < NUM_SLOTS; j++) updateSlotUI(j);
      document.getElementById('bid-panel-inactive').style.display = 'none';
      document.getElementById('bid-panel-active').style.display = '';
      const s = slotData[i] || {};
      document.getElementById('bid-slot-num').textContent = `#${i}`;
      document.getElementById('bid-current-word').textContent = s.word || '[empty]';
      document.getElementById('bid-current-owner').textContent = s.owner && s.owner !== ethers.ZeroAddress ? shortAddr(s.owner) : 'none';
      const price = typeof s.highestTotal === 'bigint' ? s.highestTotal : BigInt(s.highestTotal || 0);
      document.getElementById('bid-current-price').textContent = '$' + fmtUSDC(price);

      const MIN_BID = 250000n; // 0.25 USDC
      let yours = 0n;
      let isLeading = false;
      let userSlotCount = 0;

      if (userAddress && roundInfo?.id) {
        try {
          const rid = typeof roundInfo.id === 'bigint' ? roundInfo.id : BigInt(roundInfo.id);
          yours = await contract.cumulativeBids(rid, i, userAddress);
          document.getElementById('bid-your-total').textContent = '$' + fmtUSDC(yours);
          isLeading = yours >= price && price > 0n;

          // Get user's current slot count
          userSlotCount = Number(await contract.playerSlotCount(rid, userAddress));
        } catch(e) {
          document.getElementById('bid-your-total').textContent = '$0.00';
        }
      } else {
        document.getElementById('bid-your-total').textContent = '—';
      }

      // Check slot cap warning
      const slotCapWarning = document.getElementById('slot-cap-warning');
      const isUserSlot = s.owner && s.owner.toLowerCase() === userAddress?.toLowerCase();
      if (userSlotCount >= maxSlotsPerPlayer && !isUserSlot) {
        slotCapWarning.style.display = 'block';
        slotCapWarning.textContent = `SLOT CAP REACHED (${userSlotCount}/${maxSlotsPerPlayer})`;
      } else {
        slotCapWarning.style.display = 'none';
      }

      // Calculate overtake amount
      if (price === 0n) {
        // Empty slot — just min bid
        overtakeAmount = MIN_BID;
        document.getElementById('bid-to-overtake').textContent = 'EMPTY SLOT';
        document.getElementById('bid-to-overtake').style.color = 'var(--text-dark)';
      } else if (isLeading) {
        overtakeAmount = MIN_BID;
        document.getElementById('bid-to-overtake').innerHTML = '<span style="color:var(--green)">YOU LEAD</span> — bid to extend';
        document.getElementById('bid-to-overtake').style.color = 'var(--green)';
      } else {
        overtakeAmount = price - yours + MIN_BID;
        document.getElementById('bid-to-overtake').textContent = '$' + fmtUSDC(overtakeAmount) + ' TO OVERTAKE';
        document.getElementById('bid-to-overtake').style.color = 'var(--warn)';
      }

      // Auto-fill bid amount to overtake value
      document.getElementById('bid-amount').value = (Number(overtakeAmount) / 1e6).toFixed(2);

      // Update overtake button text
      const btnOvertake = document.getElementById('btn-overtake');
      if (isLeading) {
        btnOvertake.textContent = '✓ LEADING';
        btnOvertake.style.borderColor = 'var(--green)';
      } else if (price === 0n) {
        btnOvertake.textContent = '⚡ FIRST BID';
        btnOvertake.style.borderColor = '';
      } else {
        btnOvertake.textContent = '⚡ OVERTAKE $' + fmtUSDC(overtakeAmount);
        btnOvertake.style.borderColor = '';
      }

      document.getElementById('bid-word').focus();
    }

    function fillOvertake() {
      document.getElementById('bid-amount').value = (Number(overtakeAmount) / 1e6).toFixed(2);
    }

    function fillAmount(usd) {
      document.getElementById('bid-amount').value = usd.toFixed(2);
    }

    // ─── Explainer Modal ───────────────────────────────────
    function toggleExplainer() {
      const modal = document.getElementById('explainer-modal');
      modal.classList.toggle('open');
    }
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') document.getElementById('explainer-modal').classList.remove('open');
    });

    // ─── Connect Wallet ────────────────────────────────────
    async function connectWallet() {
      if (!window.ethereum) { showTx('NO WALLET. USE API.', 'error'); return; }
      try {
        const bp = new ethers.BrowserProvider(window.ethereum);
        await bp.send('eth_requestAccounts', []);
        try { await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: '0x2105' }] }); }
        catch(e) {
          if (e.code === 4902) await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [{ chainId: '0x2105', chainName: 'Base', nativeCurrency: { name: 'Ether', symbol: 'ETH', decimals: 18 }, rpcUrls: ['https://mainnet.base.org'], blockExplorerUrls: ['https://basescan.org'] }] });
        }
        signer = await bp.getSigner();
        userAddress = await signer.getAddress();
        contract = new ethers.Contract(CONTRACT, CONTRACT_ABI, signer);
        document.getElementById('connect-btn').textContent = shortAddr(userAddress);
        addLog('CONNECTED: ' + shortAddr(userAddress), 'highlight');
      } catch(e) { showTx('CONNECT FAILED: ' + e.message, 'error'); }
    }

    // ─── Place Bid ─────────────────────────────────────────
    let pendingBidWord = '', pendingBidAmount = 0n;

    async function placeBid() {
      if (!signer) { await connectWallet(); if (!signer) return; }
      if (selectedSlot === null) return;
      const word = document.getElementById('bid-word').value.trim();
      const amt = document.getElementById('bid-amount').value;
      if (!word) { showTx('ENTER WORD', 'error'); return; }
      if (word.includes(' ')) { showTx('ONE WORD ONLY — NO SPACES', 'error'); return; }
      if (word.length > 22) { showTx('MAX 22 CHARS', 'error'); return; }
      const amount = ethers.parseUnits(amt, 6);

      try {
        const usdc = new ethers.Contract(USDC_ADDR, USDC_ABI, signer);

        // Check balance first
        const balance = await usdc.balanceOf(userAddress);
        if (balance < amount) {
          showTx('INSUFFICIENT USDC — you have $' + fmtUSDC(balance) + ', need $' + amt, 'error');
          return;
        }

        const allowance = await usdc.allowance(userAddress, CONTRACT);
        if (allowance < amount) {
          // Need approval — show options
          pendingBidWord = word;
          pendingBidAmount = amount;
          document.getElementById('approve-exact-label').textContent = 'THIS BID ($' + amt + ')';
          document.getElementById('approve-prompt').classList.add('visible');
          return;
        }
        await submitBid(word, amount, amt);
      } catch(e) { showTx('FAILED: ' + (e.reason || e.message).slice(0,80), 'error'); }
    }

    async function doApproveAndBid(level) {
      document.getElementById('approve-prompt').classList.remove('visible');
      try {
        const usdc = new ethers.Contract(USDC_ADDR, USDC_ABI, signer);
        let approveAmount;
        switch(level) {
          case 'exact': approveAmount = pendingBidAmount; break;
          case '10': approveAmount = ethers.parseUnits('10', 6); break;
          case '50': approveAmount = ethers.parseUnits('50', 6); break;
          case 'unlimited': approveAmount = ethers.MaxUint256; break;
          default: approveAmount = pendingBidAmount;
        }
        showTx('APPROVING USDC...', 'pending');
        await (await usdc.approve(CONTRACT, approveAmount)).wait();
        const label = level === 'unlimited' ? 'UNLIMITED' : level === 'exact' ? '$' + (Number(pendingBidAmount)/1e6).toFixed(2) : '$' + level;
        addLog('USDC APPROVED: ' + label, 'highlight');
        await submitBid(pendingBidWord, pendingBidAmount, (Number(pendingBidAmount)/1e6).toFixed(2));
      } catch(e) { showTx('FAILED: ' + (e.reason || e.message).slice(0,80), 'error'); }
    }

    async function submitBid(word, amount, amtStr) {
      try {
        showTx('SUBMITTING BID...', 'pending');
        const tx = await contract.bid(selectedSlot, word, amount);
        showTx('TX: ' + shortAddr(tx.hash), 'pending');
        const r = await tx.wait();
        showTx('CONFIRMED BLOCK ' + r.blockNumber, 'success');
        addLog(`BID #${selectedSlot} "${word}" $${amtStr}`, 'highlight');
        document.getElementById('bid-word').value = '';
        await refresh();
      } catch(e) { showTx('FAILED: ' + (e.reason || e.message).slice(0,80), 'error'); }
    }

    // ─── Fund Pot ──────────────────────────────────────────
    async function fundPot() {
      if (!signer) { await connectWallet(); if (!signer) return; }
      const amt = document.getElementById('fund-amount').value;
      if (!amt || parseFloat(amt) <= 0) { showTx('ENTER AMOUNT', 'error'); return; }
      const amount = ethers.parseUnits(amt, 6);

      try {
        const usdc = new ethers.Contract(USDC_ADDR, USDC_ABI, signer);

        // Check balance
        const balance = await usdc.balanceOf(userAddress);
        if (balance < amount) {
          showTx('INSUFFICIENT USDC — you have $' + fmtUSDC(balance) + ', need $' + amt, 'error');
          return;
        }

        // Check/get approval
        const allowance = await usdc.allowance(userAddress, CONTRACT);
        if (allowance < amount) {
          showTx('APPROVING USDC...', 'pending');
          await (await usdc.approve(CONTRACT, amount)).wait();
          addLog('USDC APPROVED: $' + amt, 'highlight');
        }

        showTx('FUNDING POT...', 'pending');
        const tx = await contract.fund(amount);
        showTx('TX: ' + shortAddr(tx.hash), 'pending');
        const r = await tx.wait();
        showTx('FUNDED $' + amt, 'success');
        addLog(`FUNDED POT $${amt}`, 'highlight');
        document.getElementById('fund-amount').value = '1';
        await refresh();
      } catch(e) { showTx('FUND FAILED: ' + (e.reason || e.message).slice(0,80), 'error'); }
    }

    // ─── Start Round ───────────────────────────────────────
    async function startRound() {
      if (!signer) { await connectWallet(); if (!signer) return; }
      const top = document.getElementById('round-topup').value || '0';
      const topAmt = ethers.parseUnits(top, 6);
      try {
        if (topAmt > 0n) {
          const usdc = new ethers.Contract(USDC_ADDR, USDC_ABI, signer);
          if ((await usdc.allowance(userAddress, CONTRACT)) < topAmt) {
            showTx('APPROVING TOP-UP...', 'pending');
            await (await usdc.approve(CONTRACT, topAmt)).wait();
          }
        }
        showTx('STARTING ROUND...', 'pending');
        await (await contract.startRound(topAmt)).wait();
        showTx('ROUND STARTED', 'success');
        addLog(`ROUND INITIATED top=$${top}`, 'highlight');
        await refresh();
      } catch(e) { showTx('FAILED: ' + (e.reason || e.message), 'error'); }
    }

    // ─── Players UI ────────────────────────────────────────
    async function updatePlayersUI(players) {
      const el = document.getElementById('players-list');
      if (!players?.length) { el.innerHTML = '<span style="color:var(--text-dark)">no players</span>'; return; }
      const rid = typeof roundInfo.id === 'bigint' ? roundInfo.id : BigInt(roundInfo.id);
      let html = '';
      for (const addr of players) {
        const spent = await contract.totalSpent(rid, addr);
        let slotCount = 0;
        try {
          slotCount = Number(await contract.playerSlotCount(rid, addr));
        } catch(e) {}
        const color = addrColor(addr);
        const isYou = addr.toLowerCase() === userAddress?.toLowerCase();
        const slotsText = slotCount > 0 ? `${slotCount}/${maxSlotsPerPlayer} SLOTS` : '';
        html += `<div class="player-row">`;
        html += `<div><span class="player-dot" style="background:${color}"></span>`;
        html += `<span class="player-addr">${shortAddr(addr)}</span>`;
        html += `${isYou ? ' <span class="player-you">(YOU)</span>' : ''}`;
        html += `${slotsText ? ' <span class="player-slots">' + slotsText + '</span>' : ''}`;
        html += `</div>`;
        html += `<span class="player-spent">$${fmtUSDC(spent)}</span>`;
        html += `</div>`;
      }
      el.innerHTML = html;
    }

    // ─── Helpers ───────────────────────────────────────────
    function fmtUSDC(a) { return (Number(typeof a==='bigint'?a:BigInt(a||0))/1e6).toFixed(2); }
    function shortAddr(a) { return !a||a===ethers.ZeroAddress?'0x0':a.slice(0,6)+'…'+a.slice(-4); }
    function addrColor(a) { if(!a||a===ethers.ZeroAddress)return'#003b00'; const h=parseInt(a.slice(2,8),16)%360; return`hsl(${h},70%,45%)`; }
    function esc(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    function showTx(msg, type) {
      const el = document.getElementById('tx-status');
      el.className = 'tx-status ' + type;
      el.textContent = msg;
      if (type !== 'pending') setTimeout(() => el.className = 'tx-status', 4000);
    }
    function addLog(msg, cls = '') {
      const log = document.getElementById('event-log');
      const d = document.createElement('div');
      d.className = 'log-entry ' + cls;
      d.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      log.prepend(d);
      while (log.children.length > 50) log.lastChild.remove();
    }

    // ─── Round History ───────────────────────────────────
    async function updateHistory() {
      const el = document.getElementById('round-history');
      if (!roundInfo || !roundInfo.id) return;
      const rid = typeof roundInfo.id === 'bigint' ? Number(roundInfo.id) : Number(roundInfo.id);
      if (rid <= 0) return;

      let html = '';
      // Show up to last 5 resolved rounds (current round = rid, check backwards)
      const historyABI = [
        'function rounds(uint256) view returns (uint256 id, uint256 startTime, uint256 endTime, uint256 prizePool, bool resolved)',
      ];
      // We'll just display the current/previous round state
      const current = roundInfo;
      if (current.resolved) {
        html += `<div style="margin-bottom:6px;padding-bottom:6px;border-bottom:1px solid var(--green-dark)">`;
        html += `<span style="color:var(--text)">ROUND ${rid}</span> `;
        html += `<span style="color:var(--green)">RESOLVED</span><br>`;
        html += `<span style="color:var(--text-dark)">PRIZE: $${typeof current.prizePool === 'string' ? current.prizeFormatted : fmtUSDC(current.prizePool)} USDC</span>`;
        html += `</div>`;
      } else if (current.active) {
        html += `<div>`;
        html += `<span style="color:var(--text)">ROUND ${rid}</span> `;
        html += `<span style="color:var(--warn)">ACTIVE</span>`;
        html += `</div>`;
      }

      if (rid > 1) {
        html += `<div style="color:var(--text-dark);font-size:9px;margin-top:4px">${rid - 1} previous round${rid > 2 ? 's' : ''}</div>`;
      }

      el.innerHTML = html || '<span style="color:var(--text-dark)">no rounds yet</span>';
    }

    // ─── Word Glitch Engine ───────────────────────────────
    // Randomly scrambles a word's characters for a few frames
    const GLITCH_CHARS = 'アイウエオカキクケコ01█▓▒░<>/\\|{}[]!@#$%^&*';
    function glitchWord(el, original) {
      if (!original || original === '—') return;
      const len = original.length;
      let frames = 0;
      const maxFrames = 3 + Math.floor(Math.random() * 4);
      const interval = setInterval(() => {
        let scrambled = '';
        for (let i = 0; i < len; i++) {
          scrambled += Math.random() < 0.4
            ? GLITCH_CHARS[Math.floor(Math.random() * GLITCH_CHARS.length)]
            : original[i];
        }
        el.textContent = scrambled;
        frames++;
        if (frames >= maxFrames) {
          clearInterval(interval);
          el.textContent = original;
        }
      }, 50);
    }

    // Trigger random glitches on owned slots
    function randomGlitchLoop() {
      const owned = document.querySelectorAll('.slot.owned .slot-word');
      if (owned.length === 0) return;
      // Pick a random owned slot
      const target = owned[Math.floor(Math.random() * owned.length)];
      const original = target.getAttribute('data-glitch') || target.textContent;
      if (original && original !== '—') glitchWord(target, original);
    }
    // Fire a random glitch every 2-5 seconds
    setInterval(randomGlitchLoop, 2000 + Math.random() * 3000);
    // Also glitch on bid update (flash + scramble)
    const _origUpdateSlot = updateSlotUI;

    init();
  </script>
</body>
</html>